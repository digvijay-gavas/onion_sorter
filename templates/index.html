<body>
    <h1>Onion Labeling Tool</h1>

    <!-- Video Stream Preview -->
    <div>
        <h3>Preview Webcam Feed:</h3>
        <img id="videoPreview" src="{{ url_for('video_feed') }}" width="640" height="480" />
    </div>

    <div>
        <button id="captureBtn">Capture Image</button>
        <canvas id="canvas" style="display:none;"></canvas>
        <br>
        <button id="saveLabelBtn" style="display:none;">Save Label</button>
        <button id="recaptureBtn" style="display:none;">Recapture</button>
    </div>
    
    <h2>Captured Images</h2>
    <div id="imageList">
        {% for img in images_data %}
            <div style="display:inline-block; text-align:center;">
                <img src="{{ url_for('send_image', filename=img['image_filename']) }}" />
                <div>
                    <button onclick="deleteImage('{{ img['image_filename'] }}')">Delete</button>
                    <pre>{{ img['label'] or "No Label" }}</pre>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Existing JavaScript for capturing and labeling images -->
    <script>
        // Capture image logic (remains the same)
        let captureBtn = document.getElementById('captureBtn');
        let saveLabelBtn = document.getElementById('saveLabelBtn');
        let recaptureBtn = document.getElementById('recaptureBtn');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let currentImage = '';
        let startX, startY, endX, endY, drawing = false;

        captureBtn.onclick = function () {
            fetch('/capture', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                currentImage = data.image_path;
                let imgData = new Uint8Array(data.image_data.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                let blob = new Blob([imgData], { type: 'image/jpeg' });
                let imgUrl = URL.createObjectURL(blob);
                let img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    document.getElementById('canvas').style.display = 'block';
                    captureBtn.style.display = 'none';
                    saveLabelBtn.style.display = 'block';
                    recaptureBtn.style.display = 'block';
                };
                img.src = imgUrl;
            })
            .catch(error => console.log('Error capturing image:', error));
        };

        // Bounding Box Drawing Logic (remains the same)
        canvas.onmousedown = function (e) {
            startX = e.offsetX;
            startY = e.offsetY;
            drawing = true;
        };

        canvas.onmousemove = function (e) {
            if (drawing) {
                endX = e.offsetX;
                endY = e.offsetY;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                    ctx.beginPath();
                    ctx.rect(startX, startY, endX - startX, endY - startY);
                    ctx.strokeStyle = "red";
                    ctx.lineWidth = 3;
                    ctx.stroke();
                };
                img.src = canvas.toDataURL();
            }
        };

        canvas.onmouseup = function () {
            drawing = false;
        };

        saveLabelBtn.onclick = function () {
            if (!currentImage) {
                alert("No image to label.");
                return;
            }
            let bbox = [startX, startY, endX, endY];
            fetch('/save_label', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_filename: currentImage, bbox: bbox })
            })
            .then(response => response.json())
            .then(data => alert(data.message))
            .catch(error => console.log('Error saving label:', error));

            // Reset UI
            captureBtn.style.display = 'block';
            saveLabelBtn.style.display = 'none';
            recaptureBtn.style.display = 'none';
            canvas.style.display = 'none';
        };

        recaptureBtn.onclick = function () {
            captureBtn.click();
            captureBtn.style.display = 'block';
            saveLabelBtn.style.display = 'none';
            recaptureBtn.style.display = 'none';
        };

        // Delete Image
        function deleteImage(image_filename) {
            fetch('/delete_image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_filename: image_filename })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                location.reload();
            })
            .catch(error => console.log('Error deleting image:', error));
        }
    </script>
</body>
